{
  "version": 3,
  "sources": ["../../src/lastfm.ts", "../../src/render.ts", "../../src/local.ts", "../../src/util.ts", "../../src/rym.ts", "../../src/stream.ts", "../../src/index.ts"],
  "sourcesContent": ["import { RatingInfo } from \"./rym\";\nimport config from './config.json';\n\nexport async function fetchAlbumArtUrl({ artist, album, thumbnailUrl }: RatingInfo) {\n  const eArtist = encodeURIComponent(artist ?? \"\");\n  const eAlbum = encodeURIComponent(album ?? \"\");\n  const apiUrl =\n    `http://ws.audioscrobbler.com/2.0/?method=album.getinfo` +\n    `&api_key=${config.lastFmApiKey}&artist=${eArtist}&album=${eAlbum}&autocorrect=1&format=json`;\n\n  const rawResponse = await fetch(apiUrl);\n  const jsonResponse = await rawResponse.json();\n  if (jsonResponse.error) {\n    return thumbnailUrl;\n  } else {\n    const imgs = jsonResponse.album.image;\n    const bestImage = imgs[imgs.length - 1][\"#text\"];\n    return bestImage ?? thumbnailUrl;\n  }\n}\n", "import { RatingInfo } from './rym'\n\nexport function monthHeaderComponent(initialProps: Date) {\n  const container = document.createElement('div');\n  container.classList.add('monthHeaderContainer');\n\n  const monthHeader = document.createElement('h1');\n  container.appendChild(monthHeader);\n\n  const update = (newProps: Date) => {\n    const month = newProps.toLocaleString('default', { month: 'long' });\n    const year = newProps.toLocaleString('default', { year: 'numeric' });\n\n    monthHeader.textContent = `${month} ${year}`;\n  }\n\n  update(initialProps);\n\n  return {\n    root: container,\n    update\n  };\n}\n\n// \uD83D\uDE0D\uD83D\uDE0A\uD83D\uDE42\uD83D\uDE10\nexport function ratingComponent(initialProps: RatingInfo) {\n  const container = document.createElement('div');\n  container.classList.add('ratingContainer');\n  \n  const description = document.createElement('aside');\n  const artist = document.createElement('h1');\n  const album = document.createElement('h2');\n  description.appendChild(artist);\n  description.appendChild(album);\n  container.appendChild(description);\n\n  const rating = document.createElement('summary');\n  container.appendChild(rating);\n\n  const albumArt = document.createElement('img');\n  albumArt.addEventListener('click', () => albumArt.classList.toggle('hidden'));\n  container.append(albumArt);\n\n  const update = (newProps: Partial<RatingInfo>) => {\n    if (newProps.album) {\n      album.textContent = newProps.album;\n    }\n\n    if (newProps.artist) {\n      artist.textContent = newProps.artist;\n    }\n\n    if (newProps.ratingString) {\n      rating.textContent = getEmojiRating(newProps.ratingString);\n    }\n\n    if (newProps.thumbnailUrl) {\n      albumArt.src = newProps.thumbnailUrl;\n    }\n  }\n\n  update(initialProps);\n\n  return {\n    root: container,\n    update\n  };\n}\n\nfunction getEmojiRating(ratingString: string) {\n  const rating = parseFloat(ratingString);\n\n  if (rating > 4) return '\uD83D\uDE0D';\n  if (rating > 3) return '\uD83D\uDE0A';\n  if (rating > 2) return '\uD83D\uDE42';\n  else return '\uD83D\uDE10'; \n}", "import { RatingInfo } from \"./rym\";\n\nconst ratingsKey = 'ratings-store-v0.1';\n\nexport function getLocalRatings(): RatingInfo[] {\n  const localRatings = window.localStorage.getItem(ratingsKey);\n  if (!localRatings) {\n    return [];\n  }\n\n  try {\n    return JSON.parse(localRatings);\n  } catch {\n    return [];\n  }\n}\n\nexport function saveLocalRatings(ratings: RatingInfo[]) {\n  window.localStorage.setItem(ratingsKey, JSON.stringify(ratings));\n}", "export function delay(ms: number) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nexport function writeable<T>(val: T): { -readonly [P in keyof T]: T[P] } {\n  return val;\n}", "import { getLocalRatings, saveLocalRatings } from \"./local\";\nimport { Streamer } from \"./stream\";\nimport { delay } from \"./util\";\n\nexport type RatingInfo = ReturnType<typeof fetchRatings> extends Promise<Array<infer T>> ? T : never;\n\nexport function fetchRatings(profileName: string, page: number) {\n  const url = `https://rateyourmusic.com/collection/${profileName}/r0.5-5.0,ss.dd/${page}`;\n  return fetch(url)\n    .then((response) => response.text())\n    .then((htmlText) => {\n      const domParser = new DOMParser();\n      const document = domParser.parseFromString(htmlText, \"text/html\");\n\n      const ratingRows = document.querySelectorAll(\"table.mbgen > tbody > tr\");\n      const ratings = Array.from(ratingRows)\n        .slice(1) // the first row is the table header\n        .map((ratingRow) => {\n          return {\n            thumbnailUrl: ratingRow\n              .querySelector(\"td.or_q_thumb_album a img\")\n              ?.getAttribute(\"src\"),\n            dateString: ratingRow.querySelector(\"td.or_q_rating_date_d\")\n              ?.textContent?.trim().replace(/\\n/g, ''),\n            ratingString: ratingRow\n              .querySelector(\"td.or_q_rating_date_s img\")\n              ?.getAttribute(\"title\"), // of the format \"3.50 stars\",\n            artist: ratingRow.querySelector(\"td.or_q_albumartist_td a.artist\")\n              ?.textContent,\n            album: ratingRow.querySelector(\"td.or_q_albumartist_td a.album\")\n              ?.textContent,\n            releaseUrl: ratingRow.querySelector(\"td.or_q_albumartist_td a.album\")\n              ?.getAttribute('href'),\n            id: ratingRow.querySelector(\"td.or_q_rating_date_s span\")\n              ?.textContent, // of the format [Rating143292656],\n          } as const;\n        });\n\n      return ratings;\n    });\n}\n\nexport const ratings = (profileName: string, maxPages = 5): Streamer<RatingInfo> => async publish => {\n  console.log(\"Fetching local ratings...\");\n  const localRatings = getLocalRatings();\n  console.log(\"Found\", localRatings.length, \"existing local ratings\");\n\n  const latestLocalRating: RatingInfo | undefined = localRatings[0];\n\n  const newRatings: RatingInfo[] = [];\n  for (let page = 1; page <= maxPages; page++) {\n    console.log(\">\", \"Fetching page\", page, \"of external ratings...\");\n    const fetchedRatings = await fetchRatings(profileName, page);\n    console.log(\">\", \"Fetched\", fetchedRatings.length, \"external ratings\");\n\n    let foundMatchingLatestLocalRating = false;\n    for (const fetchedRating of fetchedRatings) {\n      if (fetchedRating.id === latestLocalRating?.id) {\n        console.log(\n          \">>\", \n          \"External rating for\",\n          fetchedRating.album,\n          \"was already found in local cache, ending external fetch\"\n        );\n        foundMatchingLatestLocalRating = true;\n        break;\n      } else {\n        console.log(\">>\", \"Publishing rating for\", fetchedRating.album);\n        publish(fetchedRating);\n        newRatings.push(fetchedRating);\n\n        console.log(\">>\", \"Waiting one second\");\n        await delay(200);\n      }\n    }\n\n    if (foundMatchingLatestLocalRating) {\n      break;\n    }\n\n    console.log(\">\", \"Waiting ten seconds...\");\n    await delay(10000);\n  }\n\n  console.log(\"Publishing\", localRatings.length, \"remaining local ratings\");\n  publish(...localRatings);\n\n  console.log(\n    \"Saving\",\n    newRatings.length + localRatings.length,\n    \"ratings to local cache\"\n  );\n  saveLocalRatings([...newRatings, ...localRatings]);\n}", "export type Mapper<T, U> = (value: T) => U;\nexport type Publisher<T> = (...results: T[]) => void;\nexport type Streamer<T> = (publisher: Publisher<T>) => void | Promise<void>;\n\nexport const stream = <T>(streamer: Streamer<T>) => {\n  const streamerStr = Math.random().toString();\n  streamer((...results) =>\n    dispatchEvent(new CustomEvent(streamerStr, { detail: results }))\n  );\n\n  return {\n    map: <U>(mapper: Mapper<T, U>) => {\n      return stream<U>((publish) => {\n        addEventListener(streamerStr, (evt) => {\n          const results = (evt as CustomEvent).detail as T[];\n          results.forEach((result) => result && publish(mapper(result)));\n        });\n      });\n    },\n  };\n};\n", "import { fetchAlbumArtUrl } from \"./lastfm\";\nimport { monthHeaderComponent, ratingComponent } from \"./render\";\nimport { ratings } from \"./rym\";\nimport { stream } from \"./stream\";\nimport config from './config.json';\n\nconst ratingsList = document.querySelector(\"div.ratings\");\nlet lastDate: Date | undefined;\n\nstream(ratings(config.rymProfile)).map(rating => {\n  console.log(\">>\", \"Rendering\", rating.album);\n  const ratingComp = ratingComponent(rating);\n\n  const ratingDate = new Date(rating.dateString!);\n  if (!lastDate || ratingDate.getMonth() !== lastDate.getMonth()) {\n    const monthHeaderComp = monthHeaderComponent(ratingDate);\n    ratingsList?.appendChild(monthHeaderComp.root);\n    lastDate = ratingDate;\n  }\n\n  ratingsList?.appendChild(ratingComp.root);\n\n  return [rating, ratingComp] as const;\n}).map(async ([rating, component]) => {\n  console.log(\">>\", \"Fetching big album art for\", rating.album);\n  let albumArtUrl = window.localStorage.getItem(`album-art-${rating.id}`) ?? \"\";\n  if (!albumArtUrl) {\n    albumArtUrl = await fetchAlbumArtUrl(rating) ?? rating.thumbnailUrl;\n    window.localStorage.setItem(`album-art-${rating.id}`, albumArtUrl);\n  }\n\n  component.update({ \n    thumbnailUrl: albumArtUrl\n  });\n  \n  return component;\n});\n"],
  "mappings": "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",
  "names": []
}
